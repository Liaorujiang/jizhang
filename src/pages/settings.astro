---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <h1 class="text-2xl font-bold text-gray-800 mb-6">设置</h1>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- 左侧导航 -->
    <div class="bg-white rounded-lg shadow-md p-4">
      <nav>
        <ul class="space-y-2">
          <li>
            <a href="#personal" class="block px-4 py-2 rounded-md bg-blue-50 text-blue-600 font-medium">个人信息</a>
          </li>
          <li>
            <a href="#categories" class="block px-4 py-2 rounded-md hover:bg-gray-100 transition-colors">分类管理</a>
          </li>
          <li>
            <a href="#payment" class="block px-4 py-2 rounded-md hover:bg-gray-100 transition-colors">支付方式管理</a>
          </li>
          <li>
            <a href="#backup" class="block px-4 py-2 rounded-md hover:bg-gray-100 transition-colors">数据备份与恢复</a>
          </li>
          <li>
            <a href="#about" class="block px-4 py-2 rounded-md hover:bg-gray-100 transition-colors">关于应用</a>
          </li>
        </ul>
      </nav>
    </div>
    
    <!-- 右侧内容 -->
    <div class="md:col-span-2 space-y-6">
      <!-- 个人信息 -->
      <div id="personal" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">个人信息</h2>
        <form id="personal-form" class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
            <input type="text" id="name" name="name" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
            <input type="email" id="email" name="email" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">修改密码</label>
            <input type="password" id="password" name="password" placeholder="输入新密码" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div class="flex justify-end">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              保存修改
            </button>
          </div>
        </form>
      </div>
      
      <!-- 分类管理 -->
      <div id="categories" class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800">分类管理</h2>
          <button id="add-category" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            + 添加分类
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="text-left py-3 px-4 font-medium text-gray-500">名称</th>
                <th class="text-left py-3 px-4 font-medium text-gray-500">类型</th>
                <th class="text-left py-3 px-4 font-medium text-gray-500">父分类</th>
                <th class="text-right py-3 px-4 font-medium text-gray-500">操作</th>
              </tr>
            </thead>
            <tbody id="category-list">
              <!-- 分类列表将通过JavaScript动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- 支付方式管理 -->
      <div id="payment" class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800">支付方式管理</h2>
          <button id="add-payment" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            + 添加支付方式
          </button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="payment-list">
          <!-- 支付方式列表将通过JavaScript动态生成 -->
        </div>
      </div>
      
      <!-- 数据备份与恢复 -->
      <div id="backup" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">数据备份与恢复</h2>
        <div class="space-y-4">
          <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-md">
            <p class="text-yellow-800">定期备份您的数据，以防数据丢失。</p>
          </div>
          <div class="flex flex-col sm:flex-row gap-4">
            <button id="export-data" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              导出数据
            </button>
            <button id="import-data" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
              导入数据
            </button>
            <button id="clear-data" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">
              清空数据
            </button>
          </div>
        </div>
      </div>
      
      <!-- 关于应用 -->
      <div id="about" class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">关于应用</h2>
        <div class="space-y-2">
          <p class="text-gray-700">个人记账 v1.0.0</p>
          <p class="text-gray-500">一个简单易用的个人财务管理工具</p>
          <p class="text-gray-500 mt-4">© 2026 个人记账 - 保留所有权利</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 分类编辑模态框 -->
  <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-bold text-gray-800 mb-4">编辑分类</h3>
      <form id="category-form" class="space-y-4">
        <input type="hidden" id="category-id">
        <div>
          <label for="category-name" class="block text-sm font-medium text-gray-700 mb-1">名称</label>
          <input type="text" id="category-name" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>
        <div>
          <label for="category-type" class="block text-sm font-medium text-gray-700 mb-1">类型</label>
          <select id="category-type" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
            <option value="income">收入</option>
            <option value="expense">支出</option>
          </select>
        </div>
        <div>
          <label for="category-parent" class="block text-sm font-medium text-gray-700 mb-1">父分类</label>
          <select id="category-parent" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="">无</option>
          </select>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" id="cancel-category" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            取消
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            保存
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 支付方式编辑模态框 -->
  <div id="payment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
      <h3 class="text-xl font-bold text-gray-800 mb-4">编辑支付方式</h3>
      <form id="payment-form" class="space-y-4">
        <input type="hidden" id="payment-id">
        <div>
          <label for="payment-name" class="block text-sm font-medium text-gray-700 mb-1">名称</label>
          <input type="text" id="payment-name" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" id="cancel-payment" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
            取消
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            保存
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    // 获取用户信息
    async function getUserInfo() {
      try {
        const response = await fetch('/api/auth/me');
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            return data.user;
          }
        }
        // 未登录，跳转到登录页面
        window.location.href = '/login';
      } catch (error) {
        console.error('获取用户信息失败:', error);
        alert('获取用户信息失败，请重新登录');
        window.location.href = '/login';
      }
    }
    
    // 个人信息保存
    document.getElementById('personal-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('name').value;
      const password = document.getElementById('password').value;
      
      try {
        const response = await fetch('/api/auth/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username: name, password })
        });
        
        const data = await response.json();
        if (data.success) {
          alert('个人信息更新成功！');
          // 刷新页面以显示更新后的信息
          window.location.reload();
        } else {
          alert('更新失败：' + data.error);
        }
      } catch (error) {
        console.error('更新个人信息失败:', error);
        alert('更新个人信息失败，请重试');
      }
    });
    
    // 加载父分类选项
    async function loadParentCategories(selectedId = null) {
      try {
        const response = await fetch('/api/categories');
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const categories = data.categories;
            const parentSelect = document.getElementById('category-parent');
            
            // 清空现有选项，保留"无"选项
            parentSelect.innerHTML = '<option value="">无</option>';
            
            // 添加分类选项
            categories.forEach(category => {
              // 排除当前编辑的分类（防止自引用）
              if (category.id !== selectedId) {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentSelect.appendChild(option);
              }
            });
          }
        }
      } catch (error) {
        console.error('加载父分类选项失败:', error);
      }
    }
    
    // 分类管理
    async function editCategory(id) {
      try {
        // 加载父分类选项
        await loadParentCategories(id);
        
        // 获取分类数据
        const response = await fetch('/api/categories');
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const categories = data.categories;
            const category = categories.find(c => c.id === id);
            
            if (category) {
              // 填充表单
              document.getElementById('category-id').value = category.id;
              document.getElementById('category-name').value = category.name;
              document.getElementById('category-type').value = category.type;
              document.getElementById('category-parent').value = category.parentId || '';
            }
          }
        }
        
        // 显示编辑模态框
        document.getElementById('category-modal').classList.remove('hidden');
      } catch (error) {
        console.error('编辑分类失败:', error);
        alert('编辑分类失败，请重试');
      }
    }
    
    async function deleteCategory(id) {
      if (confirm('确定要删除这个分类吗？')) {
        try {
          const response = await fetch('/api/categories', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('分类删除成功！');
            // 刷新分类列表
            await loadCategories();
          } else {
            alert('删除失败：' + data.error);
          }
        } catch (error) {
          console.error('删除分类失败:', error);
          alert('删除分类失败，请重试');
        }
      }
    }
    
    // 加载分类列表
    async function loadCategories() {
      try {
        const response = await fetch('/api/categories');
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const categories = data.categories;
            const categoryList = document.getElementById('category-list');
            
            if (categories.length === 0) {
              categoryList.innerHTML = `
                <tr>
                  <td colspan="4" class="py-8 text-center text-gray-500">
                    暂无分类，点击"添加分类"按钮添加
                  </td>
                </tr>
              `;
              return;
            }
            
            // 按类型分组
            const categoriesByType = {
              income: [],
              expense: []
            };
            
            categories.forEach(category => {
              if (categoriesByType[category.type]) {
                categoriesByType[category.type].push(category);
              }
            });
            
            // 生成分类HTML（按类型分组并缩进子分类）
            let html = '';
            
            // 处理收入分类
            if (categoriesByType.income.length > 0) {
              html += `
                <tr class="bg-gray-50 font-medium">
                  <td colspan="4" class="py-2 px-4 text-gray-700">收入分类</td>
                </tr>
              `;
              // 只传递顶级分类
              const topLevelIncomeCategories = categoriesByType.income.filter(c => c.parentId === null);
              html += generateCategoryHTML(topLevelIncomeCategories, categories, 0);
            }
            
            // 处理支出分类
            if (categoriesByType.expense.length > 0) {
              html += `
                <tr class="bg-gray-50 font-medium">
                  <td colspan="4" class="py-2 px-4 text-gray-700">支出分类</td>
                </tr>
              `;
              // 只传递顶级分类
              const topLevelExpenseCategories = categoriesByType.expense.filter(c => c.parentId === null);
              html += generateCategoryHTML(topLevelExpenseCategories, categories, 0);
            }
            
            categoryList.innerHTML = html;
          }
        }
      } catch (error) {
        console.error('加载分类列表失败:', error);
        alert('加载分类列表失败，请重试');
      }
    }
    
    // 递归生成分类HTML（带缩进）
    function generateCategoryHTML(categoryList, allCategories, level) {
      let html = '';
      const indent = level * 24; // 每个层级缩进24px，增强层级感
      const indicator = level > 0 ? '└─ ' : ''; // 为子分类添加视觉指示器
      
      categoryList.forEach(category => {
        // 获取父分类名称
        let parentName = '无';
        if (category.parentId) {
          const parentCategory = allCategories.find(c => c.id === category.parentId);
          if (parentCategory) {
            parentName = parentCategory.name;
          }
        }
        
        html += `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="py-3 px-4 text-gray-700" style="padding-left: ${40 + indent}px;">${indicator}${category.name}</td>
            <td class="py-3 px-4 text-gray-700">${category.type === 'income' ? '收入' : '支出'}</td>
            <td class="py-3 px-4 text-gray-500">${parentName}</td>
            <td class="py-3 px-4 text-right">
              <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="editCategory(${category.id})")>编辑</button>
              <button class="text-red-600 hover:text-red-800" onclick="deleteCategory(${category.id})")>删除</button>
            </td>
          </tr>
        `;
        
        // 递归处理子分类
        const childCategories = allCategories.filter(c => c.parentId === category.id);
        if (childCategories.length > 0) {
          html += generateCategoryHTML(childCategories, allCategories, level + 1);
        }
      });
      
      return html;
    }
    
    // 添加分类
    document.getElementById('add-category').addEventListener('click', async function() {
      try {
        // 加载父分类选项
        await loadParentCategories();
        // 显示编辑模态框
        document.getElementById('category-modal').classList.remove('hidden');
        // 清空表单
        document.getElementById('category-id').value = '';
        document.getElementById('category-name').value = '';
        document.getElementById('category-type').value = 'expense';
        document.getElementById('category-parent').value = '';
      } catch (error) {
        console.error('添加分类失败:', error);
        alert('添加分类失败，请重试');
      }
    });
    
    // 关闭分类模态框
    document.getElementById('cancel-category').addEventListener('click', function() {
      document.getElementById('category-modal').classList.add('hidden');
    });
    
    // 保存分类
    document.getElementById('category-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const id = document.getElementById('category-id').value;
      const name = document.getElementById('category-name').value;
      const type = document.getElementById('category-type').value;
      const parent = document.getElementById('category-parent').value;
      
      try {
        const method = id ? 'PUT' : 'POST';
        const response = await fetch('/api/categories', {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: id ? parseInt(id) : undefined, name, type, parentId: parent ? parseInt(parent) : null })
        });
        
        const data = await response.json();
        if (data.success) {
          // 关闭模态框
          document.getElementById('category-modal').classList.add('hidden');
          
          // 刷新分类列表
          await loadCategories();
          
          // 显示成功消息
          alert('分类保存成功！');
        } else {
          alert('保存失败：' + data.error);
        }
      } catch (error) {
        console.error('保存分类失败:', error);
        alert('保存分类失败，请重试');
      }
    });
    
    // 支付方式管理
    async function editPayment(id) {
      try {
        // 获取支付方式数据
        const response = await fetch('/api/payment-methods');
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const paymentMethods = data.paymentMethods;
            const paymentMethod = paymentMethods.find(p => p.id === id);
            
            if (paymentMethod) {
              // 填充表单
              document.getElementById('payment-id').value = paymentMethod.id;
              document.getElementById('payment-name').value = paymentMethod.name;
            }
          }
        }
        
        // 显示编辑模态框
        document.getElementById('payment-modal').classList.remove('hidden');
      } catch (error) {
        console.error('编辑支付方式失败:', error);
        alert('编辑支付方式失败，请重试');
      }
    }
    
    async function deletePayment(id) {
      if (confirm('确定要删除这个支付方式吗？')) {
        try {
          const response = await fetch('/api/payment-methods', {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('支付方式删除成功！');
            // 刷新支付方式列表
            await loadPaymentMethods();
          } else {
            alert('删除失败：' + data.error);
          }
        } catch (error) {
          console.error('删除支付方式失败:', error);
          alert('删除支付方式失败，请重试');
        }
      }
    }
    
    // 加载支付方式列表
    async function loadPaymentMethods() {
      try {
        const response = await fetch('/api/payment-methods');
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const paymentMethods = data.paymentMethods;
            const paymentList = document.getElementById('payment-list');
            
            if (paymentMethods.length === 0) {
              paymentList.innerHTML = `
                <div class="col-span-full py-8 text-center text-gray-500">
                  暂无支付方式，点击"添加支付方式"按钮添加
                </div>
              `;
              return;
            }
            
            // 生成支付方式HTML
            const html = paymentMethods.map((payment, index) => {
              const icon = ['现', '信', '支', '微', '银'][index % 5];
              return `
                <div class="border border-gray-200 rounded-md p-4 flex justify-between items-center">
                  <div class="flex items-center">
                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                      <span class="text-gray-600">${icon}</span>
                    </div>
                    <span class="text-gray-700">${payment.name}</span>
                  </div>
                  <div>
                    <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="editPayment(${payment.id})")>编辑</button>
                    <button class="text-red-600 hover:text-red-800" onclick="deletePayment(${payment.id})")>删除</button>
                  </div>
                </div>
              `;
            }).join('');
            
            paymentList.innerHTML = html;
          }
        }
      } catch (error) {
        console.error('加载支付方式列表失败:', error);
        alert('加载支付方式列表失败，请重试');
      }
    }
    
    // 添加支付方式
    document.getElementById('add-payment').addEventListener('click', function() {
      // 显示编辑模态框
      document.getElementById('payment-modal').classList.remove('hidden');
      // 清空表单
      document.getElementById('payment-id').value = '';
      document.getElementById('payment-name').value = '';
    });
    
    // 关闭支付方式模态框
    document.getElementById('cancel-payment').addEventListener('click', function() {
      document.getElementById('payment-modal').classList.add('hidden');
    });
    
    // 保存支付方式
    document.getElementById('payment-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const id = document.getElementById('payment-id').value;
      const name = document.getElementById('payment-name').value;
      
      try {
        const method = id ? 'PUT' : 'POST';
        const response = await fetch('/api/payment-methods', {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ id: id ? parseInt(id) : undefined, name })
        });
        
        const data = await response.json();
        if (data.success) {
          // 关闭模态框
          document.getElementById('payment-modal').classList.add('hidden');
          
          // 刷新支付方式列表
          await loadPaymentMethods();
          
          // 显示成功消息
          alert('支付方式保存成功！');
        } else {
          alert('保存失败：' + data.error);
        }
      } catch (error) {
        console.error('保存支付方式失败:', error);
        alert('保存支付方式失败，请重试');
      }
    });
    
    // 数据备份与恢复
    document.getElementById('export-data').addEventListener('click', async function() {
      try {
        // 导出数据到本地文件
        const [userResponse, recordsResponse, categoriesResponse, paymentMethodsResponse] = await Promise.all([
          fetch('/api/auth/me'),
          fetch('/api/records'),
          fetch('/api/categories'),
          fetch('/api/payment-methods')
        ]);
        
        const userData = await userResponse.json();
        const recordsData = await recordsResponse.json();
        const categoriesData = await categoriesResponse.json();
        const paymentMethodsData = await paymentMethodsResponse.json();
        
        const data = {
          user: userData.success ? userData.user : {},
          records: recordsData.success ? recordsData.records : [],
          categories: categoriesData.success ? categoriesData.categories : [],
          paymentMethods: paymentMethodsData.success ? paymentMethodsData.paymentMethods : []
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'personal-finance-backup.json';
        link.click();
        URL.revokeObjectURL(url);
        
        alert('数据导出成功！');
      } catch (error) {
        console.error('导出数据失败:', error);
        alert('导出数据失败，请重试');
      }
    });
    
    document.getElementById('import-data').addEventListener('click', function() {
      console.log('导入数据');
      // 创建文件输入
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async function(e) {
            try {
              const data = JSON.parse(e.target.result);
              // 这里可以实现导入数据的逻辑
              // 由于我们使用的是服务器端数据库，导入功能需要额外的API支持
              alert('导入功能暂未实现');
            } catch (error) {
              alert('数据导入失败：' + error.message);
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    });
    
    document.getElementById('clear-data').addEventListener('click', function() {
      if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
        alert('清空数据功能暂未实现');
      }
    });
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async function() {
      // 获取用户信息
      const user = await getUserInfo();
      if (user) {
        // 填充个人信息表单
        document.getElementById('name').value = user.username || '';
        document.getElementById('email').value = user.email || '';
      }
      
      // 加载分类和支付方式列表
      await loadCategories();
      await loadPaymentMethods();
    });
    
    // 暴露函数到全局作用域
    window.editCategory = editCategory;
    window.deleteCategory = deleteCategory;
    window.editPayment = editPayment;
    window.deletePayment = deletePayment;
  </script>
</Layout>