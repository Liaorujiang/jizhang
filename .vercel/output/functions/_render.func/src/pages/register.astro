---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">注册</h1>
    
    <!-- 错误提示 -->
    <div id="error-message" class="p-4 bg-red-50 border border-red-200 rounded-md mb-6 hidden">
      <p class="text-red-800" id="error-text"></p>
    </div>
    
    <!-- 成功提示 -->
    <div id="success-message" class="p-4 bg-green-50 border border-green-200 rounded-md mb-6 hidden">
      <p class="text-green-800">注册成功！正在跳转到登录页面...</p>
    </div>
    
    <form id="register-form" class="space-y-6">
      <div>
        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
        <input type="text" id="name" name="name" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入姓名" required>
      </div>
      
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
        <input type="email" id="email" name="email" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入邮箱" required>
      </div>
      
      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
        <input type="password" id="password" name="password" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请输入密码" required>
      </div>
      
      <div>
        <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
        <input type="password" id="confirm-password" name="confirm-password" class="w-full pl-3 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="请确认密码" required>
      </div>
      
      <div>
        <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          注册
        </button>
      </div>
      
      <div class="text-center">
        <p class="text-sm text-gray-700">
          已有账号？ <a href="/login" class="text-blue-600 hover:text-blue-800">立即登录</a>
        </p>
      </div>
    </form>
  </div>
  
  <script>
    // 处理表单提交
    async function handleSubmit(e) {
      e.preventDefault();
      
      // 获取表单数据
      const formData = new FormData(e.target);
      const name = formData.get('name');
      const email = formData.get('email');
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm-password');
      
      // 验证密码
      if (password !== confirmPassword) {
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = '两次输入的密码不一致';
        errorMessage.classList.remove('hidden');
        return;
      }
      
      try {
        // 发送注册请求
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, email, password, confirmPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // 注册成功，显示成功消息
          const successMessage = document.getElementById('success-message');
          successMessage.classList.remove('hidden');
          
          // 3秒后跳转到登录页面
          setTimeout(() => {
            window.location.href = '/login';
          }, 3000);
        } else {
          // 注册失败，显示错误信息
          const errorMessage = document.getElementById('error-message');
          const errorText = document.getElementById('error-text');
          errorText.textContent = data.error || '注册失败，请稍后重试';
          errorMessage.classList.remove('hidden');
        }
      } catch (error) {
        console.error('注册错误:', error);
        // 网络错误，显示错误信息
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = '网络错误，请稍后重试';
        errorMessage.classList.remove('hidden');
      }
    }
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('register-form');
      if (form) {
        form.addEventListener('submit', handleSubmit);
      }
    });
  </script>
</Layout>