async function h(){try{const e=await fetch("/api/auth/me");if(e.ok){const t=await e.json();if(t.success)return t.user}window.location.href="/login"}catch(e){console.error("获取用户信息失败:",e),alert("获取用户信息失败，请重新登录"),window.location.href="/login"}}document.getElementById("personal-form").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("name").value,n=document.getElementById("password").value;try{const a=await(await fetch("/api/auth/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:n})})).json();a.success?(alert("个人信息更新成功！"),window.location.reload()):alert("更新失败："+a.error)}catch(s){console.error("更新个人信息失败:",s),alert("更新个人信息失败，请重试")}});async function f(e=null){try{const t=await fetch("/api/categories");if(t.ok){const n=await t.json();if(n.success){const s=n.categories,a=document.getElementById("category-parent");a.innerHTML='<option value="">无</option>',s.forEach(o=>{if(o.id!==e){const c=document.createElement("option");c.value=o.id,c.textContent=o.name,a.appendChild(c)}})}}}catch(t){console.error("加载父分类选项失败:",t)}}async function E(e){try{await f(e);const t=await fetch("/api/categories");if(t.ok){const n=await t.json();if(n.success){const a=n.categories.find(o=>o.id===e);a&&(document.getElementById("category-id").value=a.id,document.getElementById("category-name").value=a.name,document.getElementById("category-type").value=a.type,document.getElementById("category-parent").value=a.parentId||"")}}document.getElementById("category-modal").classList.remove("hidden")}catch(t){console.error("编辑分类失败:",t),alert("编辑分类失败，请重试")}}async function v(e){if(confirm("确定要删除这个分类吗？"))try{const n=await(await fetch("/api/categories",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})})).json();n.success?(alert("分类删除成功！"),await p()):alert("删除失败："+n.error)}catch(t){console.error("删除分类失败:",t),alert("删除分类失败，请重试")}}async function p(){try{const e=await fetch("/api/categories");if(e.ok){const t=await e.json();if(t.success){const n=t.categories,s=document.getElementById("category-list");if(n.length===0){s.innerHTML=`
                <tr>
                  <td colspan="4" class="py-8 text-center text-gray-500">
                    暂无分类，点击"添加分类"按钮添加
                  </td>
                </tr>
              `;return}const a={income:[],expense:[]};n.forEach(c=>{a[c.type]&&a[c.type].push(c)});let o="";if(a.income.length>0){o+=`
                <tr class="bg-gray-50 font-medium">
                  <td colspan="4" class="py-2 px-4 text-gray-700">收入分类</td>
                </tr>
              `;const c=a.income.filter(r=>r.parentId===null);o+=y(c,n,0)}if(a.expense.length>0){o+=`
                <tr class="bg-gray-50 font-medium">
                  <td colspan="4" class="py-2 px-4 text-gray-700">支出分类</td>
                </tr>
              `;const c=a.expense.filter(r=>r.parentId===null);o+=y(c,n,0)}s.innerHTML=o}}}catch(e){console.error("加载分类列表失败:",e),alert("加载分类列表失败，请重试")}}function y(e,t,n){let s="";const a=n*24,o=n>0?"└─ ":"";return e.forEach(c=>{let r="无";if(c.parentId){const d=t.find(l=>l.id===c.parentId);d&&(r=d.name)}s+=`
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="py-3 px-4 text-gray-700" style="padding-left: ${40+a}px;">${o}${c.name}</td>
            <td class="py-3 px-4 text-gray-700">${c.type==="income"?"收入":"支出"}</td>
            <td class="py-3 px-4 text-gray-500">${r}</td>
            <td class="py-3 px-4 text-right">
              <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="editCategory(${c.id})")>编辑</button>
              <button class="text-red-600 hover:text-red-800" onclick="deleteCategory(${c.id})")>删除</button>
            </td>
          </tr>
        `;const i=t.filter(d=>d.parentId===c.id);i.length>0&&(s+=y(i,t,n+1))}),s}document.getElementById("add-category").addEventListener("click",async function(){try{await f(),document.getElementById("category-modal").classList.remove("hidden"),document.getElementById("category-id").value="",document.getElementById("category-name").value="",document.getElementById("category-type").value="expense",document.getElementById("category-parent").value=""}catch(e){console.error("添加分类失败:",e),alert("添加分类失败，请重试")}});document.getElementById("cancel-category").addEventListener("click",function(){document.getElementById("category-modal").classList.add("hidden")});document.getElementById("category-form").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("category-id").value,n=document.getElementById("category-name").value,s=document.getElementById("category-type").value,a=document.getElementById("category-parent").value;try{const r=await(await fetch("/api/categories",{method:t?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t?parseInt(t):void 0,name:n,type:s,parentId:a?parseInt(a):null})})).json();r.success?(document.getElementById("category-modal").classList.add("hidden"),await p(),alert("分类保存成功！")):alert("保存失败："+r.error)}catch(o){console.error("保存分类失败:",o),alert("保存分类失败，请重试")}});async function w(e){try{const t=await fetch("/api/payment-methods");if(t.ok){const n=await t.json();if(n.success){const a=n.paymentMethods.find(o=>o.id===e);a&&(document.getElementById("payment-id").value=a.id,document.getElementById("payment-name").value=a.name)}}document.getElementById("payment-modal").classList.remove("hidden")}catch(t){console.error("编辑支付方式失败:",t),alert("编辑支付方式失败，请重试")}}async function I(e){if(confirm("确定要删除这个支付方式吗？"))try{const n=await(await fetch("/api/payment-methods",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})})).json();n.success?(alert("支付方式删除成功！"),await u()):alert("删除失败："+n.error)}catch(t){console.error("删除支付方式失败:",t),alert("删除支付方式失败，请重试")}}async function u(){try{const e=await fetch("/api/payment-methods");if(e.ok){const t=await e.json();if(t.success){const n=t.paymentMethods,s=document.getElementById("payment-list");if(n.length===0){s.innerHTML=`
                <div class="col-span-full py-8 text-center text-gray-500">
                  暂无支付方式，点击"添加支付方式"按钮添加
                </div>
              `;return}const a=n.map((o,c)=>`
                <div class="border border-gray-200 rounded-md p-4 flex justify-between items-center">
                  <div class="flex items-center">
                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
                      <span class="text-gray-600">${["现","信","支","微","银"][c%5]}</span>
                    </div>
                    <span class="text-gray-700">${o.name}</span>
                  </div>
                  <div>
                    <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="editPayment(${o.id})")>编辑</button>
                    <button class="text-red-600 hover:text-red-800" onclick="deletePayment(${o.id})")>删除</button>
                  </div>
                </div>
              `).join("");s.innerHTML=a}}}catch(e){console.error("加载支付方式列表失败:",e),alert("加载支付方式列表失败，请重试")}}document.getElementById("add-payment").addEventListener("click",function(){document.getElementById("payment-modal").classList.remove("hidden"),document.getElementById("payment-id").value="",document.getElementById("payment-name").value=""});document.getElementById("cancel-payment").addEventListener("click",function(){document.getElementById("payment-modal").classList.add("hidden")});document.getElementById("payment-form").addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("payment-id").value,n=document.getElementById("payment-name").value;try{const o=await(await fetch("/api/payment-methods",{method:t?"PUT":"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t?parseInt(t):void 0,name:n})})).json();o.success?(document.getElementById("payment-modal").classList.add("hidden"),await u(),alert("支付方式保存成功！")):alert("保存失败："+o.error)}catch(s){console.error("保存支付方式失败:",s),alert("保存支付方式失败，请重试")}});document.getElementById("export-data").addEventListener("click",async function(){try{const[e,t,n,s]=await Promise.all([fetch("/api/auth/me"),fetch("/api/records"),fetch("/api/categories"),fetch("/api/payment-methods")]),a=await e.json(),o=await t.json(),c=await n.json(),r=await s.json(),i={user:a.success?a.user:{},records:o.success?o.records:[],categories:c.success?c.categories:[],paymentMethods:r.success?r.paymentMethods:[]},d=JSON.stringify(i,null,2),l=new Blob([d],{type:"application/json"}),g=URL.createObjectURL(l),m=document.createElement("a");m.href=g,m.download="personal-finance-backup.json",m.click(),URL.revokeObjectURL(g),alert("数据导出成功！")}catch(e){console.error("导出数据失败:",e),alert("导出数据失败，请重试")}});document.getElementById("import-data").addEventListener("click",function(){console.log("导入数据");const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async function(t){const n=t.target.files[0];if(n){const s=new FileReader;s.onload=async function(a){try{const o=JSON.parse(a.target.result);alert("导入功能暂未实现")}catch(o){alert("数据导入失败："+o.message)}},s.readAsText(n)}},e.click()});document.getElementById("clear-data").addEventListener("click",function(){confirm("确定要清空所有数据吗？此操作不可恢复！")&&alert("清空数据功能暂未实现")});document.addEventListener("DOMContentLoaded",async function(){const e=await h();e&&(document.getElementById("name").value=e.username||"",document.getElementById("email").value=e.email||""),await p(),await u()});window.editCategory=E;window.deleteCategory=v;window.editPayment=w;window.deletePayment=I;
