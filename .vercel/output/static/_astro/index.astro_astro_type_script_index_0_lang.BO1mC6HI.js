async function b(){try{const t=await(await fetch("/api/records")).json();if(t.success){const s=t.records,a=new Date,c=a.getMonth()+1,o=a.getFullYear();let n=0,l=0;s.forEach(r=>{const y=new Date(r.date),p=y.getMonth()+1,x=y.getFullYear();p===c&&x===o&&(r.type==="income"?n+=r.amount:r.type==="expense"&&(l+=r.amount))});const d=n-l;document.getElementById("monthly-income").textContent=`¥${n.toFixed(2)}`,document.getElementById("monthly-expense").textContent=`¥${l.toFixed(2)}`,document.getElementById("monthly-balance").textContent=`¥${d.toFixed(2)}`}}catch(e){console.error("计算月度概览错误:",e)}}async function E(){try{const t=await(await fetch("/api/records")).json();if(t.success){const s=t.records,c=new Date().getFullYear();let o=0,n=0;s.forEach(d=>{new Date(d.date).getFullYear()===c&&(d.type==="income"?o+=d.amount:d.type==="expense"&&(n+=d.amount))});const l=o-n;document.getElementById("yearly-income").textContent=`¥${o.toFixed(2)}`,document.getElementById("yearly-expense").textContent=`¥${n.toFixed(2)}`,document.getElementById("yearly-balance").textContent=`¥${l.toFixed(2)}`}}catch(e){console.error("计算年度概览错误:",e)}}function L(e){window.location.href=`/add?edit=true&id=${e}`}let m="all",g=1;const h=20;async function F(e){if(confirm("确定要删除这条记账记录吗？"))try{(await(await fetch(`/api/records/${e}`,{method:"DELETE"})).json()).success&&(b(),E(),u(m,g))}catch(t){console.error("删除记账记录错误:",t)}}function f(e){m=e,g=1,document.getElementById("all-records").className=e==="all"?"px-3 py-1 bg-blue-600 text-white rounded-md text-sm font-medium":"px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm font-medium",document.getElementById("income-records").className=e==="income"?"px-3 py-1 bg-blue-600 text-white rounded-md text-sm font-medium":"px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm font-medium",document.getElementById("expense-records").className=e==="expense"?"px-3 py-1 bg-blue-600 text-white rounded-md text-sm font-medium":"px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-sm font-medium",u(e,g)}function M(e){const t=new Date(e),s=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0"),o=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0");return`${s}-${a}-${c} ${o}:${n}`}async function u(e="all",t=1){try{const a=await(await fetch(`/api/records?type=${e==="all"?"":e}`)).json(),c=document.getElementById("transaction-list"),o=document.getElementById("pagination");if(a.success){const n=a.records;console.log("交易记录数据:",n),console.log("筛选条件:",e);const l=n.length,d=Math.ceil(l/h),r=(t-1)*h,y=r+h,p=n.slice(r,y);if(p.length===0){c.innerHTML=`
              <tr>
                <td colspan="5" class="py-8 text-center text-gray-500">
                  暂无${e==="all"?"":e==="income"?"收入":"支出"}记账记录，<a href="/add" class="text-blue-600 hover:underline">立即添加</a>
                </td>
              </tr>
            `,o.classList.add("hidden");return}const x=p.map(i=>{const w=i.type==="income"?"text-green-600":"text-red-600",$=i.type==="income"?"+":"-",B=i.categoryName||"未知分类",I=i.paymentMethodName||"未知支付方式",v=M(i.date);return console.log("显示记录:",i),`
              <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-3 px-4 text-gray-700">${v}</td>
                <td class="py-3 px-4 text-gray-700">${B}</td>
                <td class="py-3 px-4 text-gray-700">${I}</td>
                <td class="py-3 px-4 text-right ${w}">${$}¥${i.amount.toFixed(2)}</td>
                <td class="py-3 px-4 text-right">
                  <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="editTransaction(${i.id})">编辑</button>
                  <button class="text-red-600 hover:text-red-800" onclick="deleteTransaction(${i.id})">删除</button>
                </td>
              </tr>
            `}).join("");c.innerHTML=x,d>1?(o.classList.remove("hidden"),T(d,t)):o.classList.add("hidden")}}catch(s){console.error("显示最近记录错误:",s);const a=document.getElementById("transaction-list"),c=document.getElementById("pagination");a.innerHTML=`
          <tr>
            <td colspan="5" class="py-8 text-center text-gray-500">
              加载记录失败，请刷新页面重试
            </td>
          </tr>
        `,c.classList.add("hidden")}window.editTransaction=L,window.deleteTransaction=F}function T(e,t){const s=document.getElementById("page-numbers"),a=document.getElementById("prev-page"),c=document.getElementById("next-page");s.innerHTML="";for(let o=1;o<=e;o++){const n=document.createElement("button");n.className=`px-3 py-1 rounded-md text-sm ${o===t?"bg-blue-600 text-white":"border border-gray-300 text-gray-700 hover:bg-gray-50"}`,n.textContent=o,n.addEventListener("click",()=>{u(m,o)}),s.appendChild(n)}a.disabled=t===1,c.disabled=t===e,a.onclick=()=>{t>1&&u(m,t-1)},c.onclick=()=>{t<e&&u(m,t+1)}}function D(e){const t=e.target.closest("button");if(!t)return;const s=t.dataset.category,a=t.dataset.type,c=parseFloat(t.dataset.amount);window.location.href=`/add?type=${a}&amount=${c}&category=${encodeURIComponent(s)}`}document.addEventListener("DOMContentLoaded",function(){b(),E(),u(m,g),document.getElementById("all-records").addEventListener("click",()=>f("all")),document.getElementById("income-records").addEventListener("click",()=>f("income")),document.getElementById("expense-records").addEventListener("click",()=>f("expense")),document.querySelectorAll("[data-category]").forEach(t=>{t.addEventListener("click",D)})});
